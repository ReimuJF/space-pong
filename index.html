<script src="phaser.js"></script>
<script type="text/javascript">

	var game = new Phaser.Game(480, 600, Phaser.AUTO, 'Space Pong', { preload: preload, create: create, update: update });
	
	var logo;
	var textH;
    var playerBet;
    var computerBet;
    var ball;
	var explosions;
	var sexplosions;
	
	var score = 0;
	var computerBetSpeed = 250;
    var ballSpeed = 300;
	var ballReleased = false;
	
	var music;
	var fxhit;
	var fxwin;
	var fxlose;
	var starfield;
	var flag = true;
	var ShiftButton;
	
	var mmuteButton;
	var startButton;
	
    
    function preload() {
        game.load.image('bet', 'assets/bet.png');
		game.load.image('bet2', 'assets/bet2.png');	
        game.load.image('ball', 'assets/ball.png');
        game.load.image('background', 'assets/starfield.jpg');
		game.load.image('star', 'assets/star.png');
		game.load.image('logo', 'assets/space.png');
		game.load.audio('bgm', 'assets/audio/bgm.mp3');
		game.load.audio('sfx', 'assets/audio/exp.wav');
		game.load.audio('win', 'assets/audio/exp2.wav');
		game.load.audio('lose', 'assets/audio/exp3.wav');
		game.load.spritesheet('kaboom', 'assets/explode.png', 128, 128);
		game.load.spritesheet('kaboom2', 'assets/explode2.png', 32, 32);
    }
	

    function create() {
		music = game.add.audio('bgm');
		music.play('',0,0.15,true);
		fxhit = game.add.audio('sfx');
		fxwin = game.add.audio('win');
		fxlose = game.add.audio('lose');
	    game.physics.startSystem(Phaser.Physics.ARCADE);

			//  We check bounds collisions against all walls other than the bottom one
		game.physics.arcade.checkCollision.down = false;
		//game.canvas.style.cursor = 'none';
        starfield = game.add.tileSprite(0, 0, 480, 600, 'background');
		textScore = game.add.text(0, 0, 'Score: ' + score , {fill: 'efefef'});
		text = game.add.text(game.world.centerX, game.world.centerY-30, '', {fill: '#efefef'});
		text.anchor.setTo(0.5);
		playerBet = createBet(game.world.centerX-50, 550);
        computerBet = createBet2(game.world.centerX, 50);
		
		
		
		
		ball = game.add.sprite(game.world.centerX, game.world.centerY, 'ball');
        ball.anchor.setTo(0.5);
		game.physics.enable(ball, Phaser.Physics.ARCADE);
        ball.body.collideWorldBounds = true;
        ball.body.bounce.setTo(1);
		
		
		
		emitter = game.add.emitter(0, 0, 200);
		emitter.makeParticles('star');
		
		logo = game.add.sprite(10, 100, 'logo');
		logo.fixedToCamera = true;
		textH = game.add.text(game.world.centerX-110, game.world.centerY+40, 'Controls:\nArrows to move\nShift+Arrows to boost\nSpace to release ball\n1 to mute music', {fill: '#efefef'});
		
		    explosions = game.add.group();

    for (var i = 0; i < 16; i++)
    {
        var explosionAnimation = explosions.create(0, 0, 'kaboom', [0], false);
        explosionAnimation.anchor.setTo(0.5, 0.5);
        explosionAnimation.animations.add('kaboom');
    }
	
		sexplosions = game.add.group();
	    for (var i = 0; i < 16; i++)
    {
        var explosionAnimation = sexplosions.create(0, 0, 'kaboom2', [0], false);
        explosionAnimation.anchor.setTo(0.5, 0.5);
        explosionAnimation.animations.add('kaboom2');
    }

		
		cursors = game.input.keyboard.createCursorKeys();
		startButton = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
		ShiftButton = game.input.keyboard.addKey(Phaser.Keyboard.SHIFT);
		mmuteButton = game.input.keyboard.addKey(Phaser.Keyboard.ONE);
		startButton.onDown.add(releaseBall, this);
		startButton.onDown.add(destroyLogo, this);
		startButton.onDown.add(revive, this);
		mmuteButton.onDown.add(MusicPause, this);
		//game.input.onDown.add(releaseBall, this);
    }
	
	function destroyLogo(){
	logo.kill();
	textH.destroy();
	}
	
	function MusicPause(){
	if (flag)
		{
	music.pause();
	}
	else
	{
	music.resume();
	}
	flag = !flag;
	}
	
	function ShiftSpeedUp(){

	
	}
	
	function particleBurst(x, y) {

		//  Position the emitter where the mouse/touch event was
		emitter.x = x;
		emitter.y = y;

		//  The first parameter sets the effect to "explode" which means all particles are emitted at once
		//  The second gives each particle a 2000ms lifespan
		//  The third is ignored when using burst/explode mode
		//  The final parameter (10) is how many particles will be emitted in this single burst
		emitter.start(true, 200, null, 5);}
	
	function createBet(x, y) {
		
        var bet = game.add.sprite(x, y, 'bet');
        bet.anchor.setTo(0.5);
		game.physics.enable(bet, Phaser.Physics.ARCADE);
        bet.body.collideWorldBounds = true;
        bet.body.bounce.setTo(1);
        bet.body.immovable = true;

        return bet;
    }
	
		
	function createBet2(x, y) {
		
        var bet = game.add.sprite(x, y, 'bet2');
        bet.anchor.setTo(0.5);
		game.physics.enable(bet, Phaser.Physics.ARCADE);
        bet.body.collideWorldBounds = true;
        bet.body.bounce.setTo(1);
        bet.body.immovable = true;

        return bet;
    }
	
	    function releaseBall() {
        if (!ballReleased) {
            ball.body.velocity.x = ballSpeed;
            ball.body.velocity.y = -ballSpeed;
            ballReleased = true;
        }
    }
		
	

    function update () {
        //”правл¤ем ракеткой игрока
       //playerBet.x = game.input.x;
	   
	    starfield.tilePosition.y += 2;
		
		 playerBet.body.velocity.setTo(0, 0);

    if (cursors.left.isDown)
    {
        playerBet.body.velocity.x = -600;
    }
    else if (cursors.right.isDown)
    {
        playerBet.body.velocity.x = 600;
    }
	if (ShiftButton.isDown && cursors.left.isDown)
    {
        playerBet.body.velocity.x = -900;
    }
	 else if (ShiftButton.isDown && cursors.right.isDown)
    {
        playerBet.body.velocity.x = 900;
    }

        var playerBetHalfWidth = playerBet.width / 2;

        if (playerBet.x < playerBetHalfWidth) {
            playerBet.x = playerBetHalfWidth;
        }
        else if (playerBet.x > game.width - playerBetHalfWidth) {
            playerBet.x = game.width - playerBetHalfWidth;
        }

        //”правл¤ем ракеткой компьютерного соперника
        if(computerBet.x - ball.x < -15) {
            computerBet.body.velocity.x = computerBetSpeed;
        }
        else if(computerBet.x - ball.x > 15) {
            computerBet.body.velocity.x = -computerBetSpeed;
        }
        else {
            computerBet.body.velocity.x = 0;
        }
		
		game.physics.arcade.collide(ball, playerBet, ballHitsBet, null, this);
        game.physics.arcade.collide(ball, computerBet, ballHitsBet, null, this);
		
		checkGoal();
    }
	
	 function ballHitsBet (_ball, _bet) {
	 
		/*if (ball.y < 60) {
			emitter.gravity = 5;
			
		} else if (ball.y > 580) {
			emitter.gravity = -5;
		}
		particleBurst(_bet.x, _bet.y);*/
		
		var explosion = sexplosions.getFirstExists(false);
			explosion.reset(_bet.body.x+70, _bet.body.y+35);
			explosion.play('kaboom2', 30, false, true);
		
        var diff = 0;

        if (_ball.x < _bet.x) {
            //  шарик находитс¤ с левой стороны ракетки
            diff = _bet.x - _ball.x;
            _ball.body.velocity.x = (-10 * diff);
        }
        else if (_ball.x > _bet.x) {
            //  шарик находитс¤ с правой стороны ракетки
            diff = _ball.x -_bet.x;
            _ball.body.velocity.x = (10 * diff);
        }
        else {
            //  шарик попал в центр ракетки, добавл¤ем немножко трагической случайности его движению
            _ball.body.velocity.x = 2 + Math.random() * 8;
        }
		fxhit.play('',0,0.1);
    }
	
		function showText(txt, timeout) {
		text.setText(txt);
		setTimeout(function() {
			text.setText('');
		}, timeout);
	}
	
	    function checkGoal() {
        if (ball.y < 25) {
			computerBet.kill();
			var explosion = explosions.getFirstExists(false);
			explosion.reset(computerBet.body.x+70, computerBet.body.y+35);
			explosion.play('kaboom', 30, false, true);
			computerBetSpeed += 100;
			ballSpeed += 110;
			score += 1;
			textScore.setText('Score: ' + score);
			showText('ENEMY SHIP ELIMINATED!', 2000);
			fxwin.play('',0,0.1);
			setBall();
	

        } else if (ball.y > 580) {
			playerBet.kill();
			var explosion = explosions.getFirstExists(false);
			explosion.reset(playerBet.body.x+70, playerBet.body.y+35);
			explosion.play('kaboom', 30, false, true);
            setBall();
			computerBetSpeed = 250;
			score = 0;
			textScore.setText('Score: ' + score);
			showText('YOU ARE DEFEATED!', 2000);
			ballSpeed = 300;
			fxlose.play('',0,0.1);			
        }
    }
	function revive(){
	computerBet.revive();
	playerBet.revive();
	}

    function setBall() {
        if (ballReleased) {
            ball.x = game.world.centerX;
            ball.y = game.world.centerY;
            ball.body.velocity.x = 0;
            ball.body.velocity.y = 0;
            ballReleased = false;
        }
		function render() {
    game.debug.soundInfo(music, 200, 320);
}

        
    }
</script>